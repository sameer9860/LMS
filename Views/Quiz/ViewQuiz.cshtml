@model LMS.Models.Quiz

@{
    ViewData["Title"] = "View Quiz - " + Model.Title;
    var mcqs = Model.MCQs?.ToList() ?? new List<LMS.Models.MCQ>();
}

<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">@Model.Title</h2>
        </div>
        <div class="card-body">
            <p><strong>Type:</strong> 
                <span class="badge bg-@(Model.Type == LMS.Models.QuizType.AI ? "success" : "info")">
                    @(Model.Type == LMS.Models.QuizType.AI ? "AI Generated" : "Manual")
                </span>
            </p>
            <p><strong>Description:</strong> @(string.IsNullOrEmpty(Model.Description) ? "No description provided" : Model.Description)</p>
            <p><strong>Due Date:</strong> @Model.DueDate.ToString("MMMM dd, yyyy HH:mm")</p>
            @if (!string.IsNullOrEmpty(Model.MaterialPath))
            {
                <p><strong>Material:</strong> <a href="@Model.MaterialPath" target="_blank" class="btn btn-sm btn-outline-secondary">Download Material</a></p>
            }
            <hr />
            <p><strong>Total Questions:</strong> <span class="badge bg-dark">@(Model.MCQs?.Count ?? 0)</span></p>
        </div>
    </div>

    <h3 class="mb-3">Questions</h3>

    @if (Model.MCQs != null && Model.MCQs.Count > 0)
    {
        @foreach (var mcq in mcqs)
        {
            var i = mcqs.IndexOf(mcq);
            <div class="card mb-3 p-4">
                <div class="card-body">
                    <h5 class="card-title">Question @(i + 1)</h5>
                    <p class="card-text"><strong>@mcq.Question</strong></p>

                    <div class="options-container ms-3">
                        <p><strong>A.</strong> @mcq.OptionA</p>
                        <p><strong>B.</strong> @mcq.OptionB</p>
                        <p><strong>C.</strong> @mcq.OptionC</p>
                        <p><strong>D.</strong> @mcq.OptionD</p>
                        @if (!string.IsNullOrEmpty(mcq.OptionE))
                        {
                            <p><strong>E.</strong> @mcq.OptionE</p>
                        }
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>Correct Answer:</strong> <span class="badge bg-success">@mcq.CorrectAnswer</span></p>
                        @if (!string.IsNullOrEmpty(mcq.Feedback))
                        {
                            <p class="mb-0"><strong>Feedback:</strong> @mcq.Feedback</p>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">No questions found in this quiz.</div>
    }

    <div class="d-flex gap-2 mt-4">
        <a asp-action="EditQuiz" asp-route-quizId="@Model.Id" class="btn btn-warning">
            <i class="fas fa-edit"></i> Edit Quiz
        </a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteQuizModal" onclick="setQuizDeleteData(@Model.Id, '@Model.Title')">
            <i class="fas fa-trash"></i> Delete Quiz
        </button>
        <a href="javascript:history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Delete Quiz Modal -->
<div class="modal fade" id="deleteQuizModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete Quiz</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this quiz: <strong id="deleteQuizTitle"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteQuiz()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let quizIdToDelete = 0;

function setQuizDeleteData(quizId, quizTitle) {
    quizIdToDelete = quizId;
    document.getElementById('deleteQuizTitle').textContent = quizTitle;
}

function confirmDeleteQuiz() {
    if (quizIdToDelete === 0) return;

    fetch('/Quiz/DeleteQuiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quizId: quizIdToDelete })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Quiz deleted successfully!');
            window.location.href = window.history.back();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the quiz.');
    });
}
</script>
