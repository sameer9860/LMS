@model LMS.Controllers.TakeQuizViewModel

@{
    ViewData["Title"] = "Take Quiz - " + Model.Title;
}

<div class="container mt-4">
    <h2 class="mb-4">@Model.Title</h2>

    <form id="quizForm">
        <input type="hidden" id="quizId" value="@Model.QuizId" />

        @for (int i = 0; i < Model.MCQs.Count; i++)
        {
            var question = Model.MCQs[i];
            <div class="card mb-3 p-4">
                <p><strong>Question @(i + 1) of @Model.MCQs.Count:</strong> @question.Question</p>

                <div class="options-container">
                    @for (int j = 0; j < question.Options.Count; j++)
                    {
                        var option = question.Options[j];
                        var inputId = $"q{i}_option{j}";
                        <div class="form-check mb-2">
                            <input class="form-check-input quiz-answer" 
                                   type="radio" 
                                   id="@inputId" 
                                   name="question_@i" 
                                   value="@option"
                                   data-question-id="@i"
                                   required />
                            <label class="form-check-label" for="@inputId">
                                @option
                            </label>
                        </div>
                    }
                </div>
            </div>
        }

        <div class="d-flex gap-2">
            <button type="button" id="submitBtn" class="btn btn-primary btn-lg">
                <i class="fas fa-check"></i> Submit Quiz
            </button>
            <a href="javascript:history.back()" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById('submitBtn').addEventListener('click', async function() {
    // Collect answers
    const answers = [];
    const questions = @Model.MCQs.Count;
    let allAnswered = true;

    @for (int i = 0; i < Model.MCQs.Count; i++)
    {
        <text>
        const selected_</text>@i<text> = document.querySelector('input[name="question_</text>@i<text>"]:checked');
        if (!selected_</text>@i<text>) {
            allAnswered = false;
        } else {
            answers.push({
                mcqId: </text>@(i + 1)<text>,
                answer: selected_</text>@i<text>.value
            });
        }
        </text>
    }

    if (!allAnswered) {
        Swal.fire({
            icon: 'warning',
            title: 'Incomplete',
            text: 'Please answer all questions before submitting.'
        });
        return;
    }

    // Show loading
    Swal.fire({
        title: 'Submitting...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const response = await fetch('/Quiz/SubmitQuiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quizId: parseInt(document.getElementById('quizId').value),
                answers: answers
            })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Quiz Submitted!',
                html: `<p>Your Score: <strong>${data.score}/${data.totalQuestions}</strong></p><p>${data.percentage}%</p>`,
                confirmButtonText: 'View Results'
            }).then(() => {
                window.location.href = `/Quiz/QuizResult/${data.submissionId}`;
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to submit quiz. Please try again.'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while submitting the quiz.'
        });
    }
});
</script>
}
